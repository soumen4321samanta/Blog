{% extends 'base.html' %}
{% block title %}Change Password{% endblock %}

{% block styles %}
<style>
:root {
  --primary-color: #4a90e2;
  --primary-hover: #357abd;
  --bg-color: #f0f2f5;
  --text-color: #333;
  --error-color: #e74c3c;
  --success-color: #2ecc71;
  --input-bg: #fff;
  --input-border: #dce0e3;
  --input-focus-shadow: rgba(74, 144, 226, 0.2);
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  font-family: 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
  line-height: 1.6;
}

.container {
  max-width: 450px;
  margin: 3rem auto;
  margin-top: 30px;
  padding: 2.5rem;
  background-color: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.container:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
}

h2 {
  text-align: center;
  color: var(--primary-color);
  margin-bottom: 2rem;
  font-size: 2rem;
  font-weight: 600;
  letter-spacing: -0.5px;
}

.form-group {
  margin-bottom: 1.8rem;
  position: relative;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #555;
  transition: color 0.3s ease;
}

.form-control {
  width: 100%;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  border: 2px solid var(--input-border);
  border-radius: 8px;
  background-color: var(--input-bg);
  transition: all 0.3s ease;
}

.form-control:focus {
  border-color: var(--primary-color);
  outline: 0;
  box-shadow: 0 0 0 4px var(--input-focus-shadow);
}

.form-group:focus-within label {
  color: var(--primary-color);
}

.btn-primary {
  display: block;
  width: 100%;
  padding: 0.75rem;
  font-size: 1.1rem;
  font-weight: 600;
  color: #fff;
  background-color: var(--primary-color);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.btn-primary:hover {
  background-color: var(--primary-hover);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
}

.btn-primary:active {
  transform: translateY(0);
}

.error-message {
  color: var(--error-color);
  font-size: 0.875rem;
  margin-top: 0.5rem;
  padding: 0.5rem;
  border-radius: 4px;
  background-color: rgba(231, 76, 60, 0.1);
  border-left: 3px solid var(--error-color);
}

.success-message {
  color: var(--success-color);
  font-size: 0.875rem;
  margin-top: 0.5rem;
  padding: 0.5rem;
  border-radius: 4px;
  background-color: rgba(46, 204, 113, 0.1);
  border-left: 3px solid var(--success-color);
}

/* Responsive styles */
@media (max-width: 768px) {
  .container {
    max-width: 90%;
    padding: 2rem;
    margin: 2rem auto;
    margin-top: 30px;
  }
}

/* Password strength meter */
.password-strength-meter {
  height: 6px;
  background-color: #e0e0e0;
  margin-top: 0.75rem;
  border-radius: 3px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.password-strength-meter div {
  height: 100%;
  width: 0;
  transition: all 0.3s ease;
  border-radius: 3px;
}

.strength-weak { background-color: #ff4136; }
.strength-fair { background-color: #ffdc00; }
.strength-good { background-color: #2ecc40; }
.strength-strong { background-color: #0074d9; }

/* Show/Hide password toggle */
.password-toggle {
  position: absolute;
  right: 10px;
  top: 60%;
  transform: translateY(-50%);
  cursor: pointer;
  color: #6c757d;
  transition: color 0.3s ease;
  z-index: 2;
}

.password-toggle:hover {
  color: var(--primary-color);
}

.password-toggle i {
  font-size: 1.2rem;
}

/* Password hint */
#passwordHint {
  display: block;
  font-size: 0.8rem;
  color: #666;
  margin-top: 0.5rem;
  font-style: italic;
}

/* Form shake animation for errors */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.shake {
  animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both;
}

/* Focus styles for accessibility */
*:focus {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: var(--primary-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-hover);
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h2>Change Password</h2>
  <form id="changePasswordForm" method="post" action="{% url 'custom_change_password' %}">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div class="form-group">
      <label for="oldPassword">Old Password:</label>
      <input type="password" id="oldPassword" name="old_password" class="form-control" required>
      <span class="password-toggle" data-target="oldPassword">
        <i class="fas fa-eye"></i>
      </span>
    </div>
    <div class="form-group">
      <label for="newPassword">New Password:</label>
      <input type="password" id="newPassword" name="new_password" class="form-control" required>
      <span class="password-toggle" data-target="newPassword">
        <i class="fas fa-eye"></i>
      </span>
      <div class="password-strength-meter">
        <div id="strengthMeter"></div>
      </div>
      <small id="passwordHint" class="form-text text-muted"></small>
    </div>
    <div class="form-group">
      <label for="confirmPassword">Confirm New Password:</label>
      <input type="password" id="confirmPassword" name="confirm_password" class="form-control" required>
      <span class="password-toggle" data-target="confirmPassword">
        <i class="fas fa-eye"></i>
      </span>
    </div>
    <button type="submit" class="btn btn-primary">
      <i class="fas fa-check"></i> Change Password
    </button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('changePasswordForm');
  const newPasswordInput = document.getElementById('newPassword');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const strengthMeter = document.getElementById('strengthMeter');
  const passwordHint = document.getElementById('passwordHint');

  // Password strength meter
  newPasswordInput.addEventListener('input', function() {
    const password = this.value;
    const result = zxcvbn(password);
    
    // Update strength meter
    strengthMeter.className = '';
    strengthMeter.style.width = `${(result.score + 1) * 25}%`;
    
    if (result.score < 2) {
      strengthMeter.classList.add('strength-weak');
      passwordHint.textContent = 'Weak password. Try adding numbers and special characters.';
    } else if (result.score < 3) {
      strengthMeter.classList.add('strength-fair');
      passwordHint.textContent = 'Fair password. Consider making it longer.';
    } else if (result.score < 4) {
      strengthMeter.classList.add('strength-good');
      passwordHint.textContent = 'Good password!';
    } else {
      strengthMeter.classList.add('strength-strong');
      passwordHint.textContent = 'Strong password. Great job!';
    }
  });

  // Form submission
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    if (newPassword !== confirmPassword) {
      showError('New password and confirm password do not match.');
      form.classList.add('shake');
      setTimeout(() => form.classList.remove('shake'), 600);
      return;
    }

    if (zxcvbn(newPassword).score < 3) {
      showError('Please choose a stronger password.');
      form.classList.add('shake');
      setTimeout(() => form.classList.remove('shake'), 600);
      return;
    }

    // If all validations pass, submit the form
    this.submit();
  });

  // Show/Hide password toggle
  document.querySelectorAll('.password-toggle').forEach(toggle => {
    toggle.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const passwordInput = document.getElementById(targetId);
      const icon = this.querySelector('i');

      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    });
  });

  function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    form.insertBefore(errorDiv, form.firstChild);

    setTimeout(() => {
      errorDiv.remove();
    }, 5000);
  }
});
</script>
{% endblock %}